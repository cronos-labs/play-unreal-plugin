name: Unreal Devlopment Build

on:
  push:
    branches:
      - main
    paths-ignore:
      - README.md
    tags:
      - "v*.*.*"
  pull_request:
    paths-ignore:
      - README.md

jobs:
  clone:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        path: ./.github/actions/play-unreal-plugin
    # we can not share folders directly between jobs
    # Thats' why we use upload-artifact/download-artifact as a workaround
    - uses: actions/upload-artifact@v3
      with:
        name: play-unreal-plugin
        path: ./.github/actions/play-unreal-plugin

  build:
    needs: clone
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/epicgames/unreal-engine:dev-slim-4.27.2
      credentials:
        username: gamefimachine
        password: ${{ secrets.PAT }}
    steps:
      # TODO Update download-artifact to 3.0.1+
      #
      # Starting from 3.0.1, it generates permission error (set-ouput), due to the update of
      # actions/core to 1.10.0
      #
      # See:
      # - https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/
      # - https://github.com/actions/download-artifact/commit/9782bd6a9848b53b110e712e20e42d89988822b7
      #
      # As we only download the artifacts, it is ok to keep using the old version - 3.0.0 to
      # avoid the complicated permission error in container
    - uses: actions/download-artifact@v3.0.0
      with:
        name: play-unreal-plugin
        path: /home/ue4/play-unreal-plugin

    - name: Install play-cpp-sdk
      working-directory: /home/ue4/play-unreal-plugin
      run: make

    - name: Build Plugin
      working-directory: /home/ue4/play-unreal-plugin
      env:
        HOME: /home/ue4
      run: make RunUAT
